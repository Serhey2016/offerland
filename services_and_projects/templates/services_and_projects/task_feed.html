{% load static %}

<!-- My Task Feed CSS -->
<link rel="stylesheet" href="{% static 'css/my_task_feed.css' %}">

<div class="social_feed2" data-id="{{ task.id }}" data-task-type="{{ task.type_of_task.type_of_task_name|lower }}">
    <div class="post_info_block">
        <div class="post_info_dates">
                    <div class="post_info_start_date_column">
            <span class="post_info_start_date">start date:</span>
            <span class="post_start_date">
                {% if task.date_start %}
                    {{ task.date_start|date:'d.m.Y' }}
                {% else %}
                    Not started
                {% endif %}
            </span>
        </div>
            <div class="post_info_dates_type_of_task">{{ task.type_of_task.type_of_task_name }}</div>
            <div class="post_info_end_date_column">
                <span class="post_info_end_date">last update:</span>
                <span class="post_end_date">{{ task.updated_at|date:'d.m.Y' }}</span>
            </div>
        </div>
        <div class="my_task_social_feed_menu" id="my_task_social_feed_menu_{{ task.type_of_task.type_of_task_name|lower }}_{{ task.id }}">
            <!-- Heart icon for favorites -->
            <span class="sftsts1_favorites_icon favorite-unchecked" id="favorites_icon_{{ task.id }}" data-favorite="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </span>
            
            <!-- Overflow Menu Icon Trigger -->
            <div class="my_task_social_feed_overflow_menu_trigger" id="overflow_menu_trigger_{{ task.type_of_task.type_of_task_name|lower }}_{{ task.id }}" title="Menu">
                <span class="overflow_menu_icon">⋮</span>
            </div>
            
            <!-- Overflow Menu -->
            <div class="my_task_social_feed_overflow_menu" id="my_task_overflow_menu_{{ task.type_of_task.type_of_task_name|lower }}_{{ task.id }}">
                <div class="my_task_social_feed_overflow_menu_item start" id="menu_item_start_{{ task.type_of_task.type_of_task_name|lower }}_{{ task.id }}" data-action="start" data-id="{{ task.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    Start
                </div>
                <div class="my_task_social_feed_overflow_menu_item edit" id="menu_item_edit_{{ task.type_of_task.type_of_task_name|lower }}_{{ task.id }}" data-action="edit" data-id="{{ task.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    Edit
                </div>
                <div class="my_task_social_feed_overflow_menu_item publish" id="menu_item_publish_{{ task.type_of_task.type_of_task_name|lower }}_{{ task.id }}" data-action="publish" data-id="{{ task.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    Publish
                </div>
                <div class="my_task_social_feed_overflow_menu_item archive" id="menu_item_archive_{{ task.type_of_task.type_of_task_name|lower }}_{{ task.id }}" data-action="archive" data-id="{{ task.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5l-4-4h2.5V12h3v1.5H16l-4 4z"/>
                    </svg>
                    Archive
                </div>
            </div>
        </div>
    </div>
    
    <div class="post_info_title_row">
        <div class="post_info_project_or_task_title_column">
            <span class="post_info_project_or_task_title_text">{{ task.title }}</span>
        </div>
        <div class="post_info_icons_scroll">
            <div id="my_task_notes_icon_{{ task.id }}" class="post_info_icon my_task_notes_icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="76.191" height="50.794" viewBox="0 0 76.191 50.794">
                    <path id="notes_24dp_E3E3E3_FILL0_wght400_GRAD0_opsz24" d="M120-669.206v-8.466h50.794v8.466Zm0-21.164v-8.466h76.191v8.466Zm0-21.164V-720h76.191v8.466Z" transform="translate(-120 720)" fill="#dfb30b"/>
                </svg>   
            </div>

        </div>
    </div>

    <div class="social_feed_hide_icon" id="socialFeedHideIcon_{{ task.id }}">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35" viewBox="0 0 86.55 86.55">
            <defs>
                <filter id="Ellipse_16" x="0" y="0" width="86.55" height="86.55" filterUnits="userSpaceOnUse">
                    <feOffset dy="3" input="SourceAlpha" />
                    <feGaussianBlur stdDeviation="3" result="blur" />
                    <feFlood flood-opacity="0.161" />
                    <feComposite operator="in" in2="blur" />
                </filter>
                <filter id="Ellipse_16-2" x="0" y="0" width="86.55" height="86.55" filterUnits="userSpaceOnUse">
                    <feOffset dy="3" input="SourceAlpha" />
                    <feGaussianBlur stdDeviation="3" result="blur-2" />
                    <feFlood flood-opacity="0.161" result="color" />
                    <feComposite operator="out" in="SourceGraphic" in2="blur-2" />
                    <feComposite operator="in" in="color" />
                    <feComposite operator="in" in2="SourceGraphic" />
                </filter>
            </defs>
            <g id="Group_4185" data-name="Group 4185" transform="translate(9 6)">
                <g data-type="innerShadowGroup">
                    <g transform="matrix(1, 0, 0, 1, -9, -6)" filter="url(#Ellipse_16)">
                        <g id="Ellipse_16-3" data-name="Ellipse 16" transform="translate(9 6)" fill="#fefbd7" stroke="#ececec" stroke-width="1">
                            <circle cx="34.275" cy="34.275" r="34.275" stroke="none" />
                            <circle cx="34.275" cy="34.275" r="33.775" fill="none" />
                        </g>
                    </g>
                    <circle id="Ellipse_16-4" data-name="Ellipse 16" cx="34.275" cy="34.275" r="34.275" transform="translate(0)" fill="#fefbd7" />
                    <g transform="matrix(1, 0, 0, 1, -9, -6)" filter="url(#Ellipse_16-2)">
                        <circle id="Ellipse_16-5" data-name="Ellipse 16" cx="34.275" cy="34.275" r="34.275" transform="translate(9 6)" fill="#fff" />
                    </g>
                    <g id="Ellipse_16-6" data-name="Ellipse 16" transform="translate(0)" fill="none" stroke="#ececec" stroke-width="1">
                        <circle cx="34.275" cy="34.275" r="34.275" stroke="none" />
                        <circle cx="34.275" cy="34.275" r="33.775" fill="none" />
                    </g>
                </g>
                <path id="arrow_back_ios_24dp_000000_FILL0_wght400_GRAD0_opsz24" d="M17,33.99,0,17,17,0l3.017,3.017L6.033,17,20.012,30.974Z" transform="translate(52.029 22.465) rotate(90)" fill="gray" />
            </g>
        </svg>
    </div>

    <div class="social_feed_details" id="socialFeedDetails_{{ task.id }}" style="display:none;">
        <div class="social_feed_details_section">
            <div class="social_feed_details_label">Description:</div>
            <div class="social_feed_details_text">
                {{ task.description|linebreaks }}
            </div>
        </div>
        
        {% if task.photo_link or task.photos.all %}
        <div class="social_feed_details_section">
            <div class="social_feed_details_label">Photos:</div>
            <div class="social_feed_details_photos">
                {% if task.photo_link %}
                    <a href="{{ task.photo_link }}" target="_blank" class="photo-link-exclude">
                        Link
                    </a>
                {% endif %}
                {% for photo in task.photos.all %}
                    {% if photo.photo %}
                        <a href="{{ photo.photo.url }}" data-pswp-width="1200" data-pswp-height="800" target="_blank" class="photo-gallery-item">
                            <img src="{{ photo.photo.url }}" alt="Task photo">
                        </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if task.hashtags.all %}
        <div class="social_feed_details_section">
            <div class="social_feed_details_label">Hashtags:</div>
            <div class="social_feed_tags">
                {% for hashtag in task.hashtags.all %}
                    <span>{{ hashtag.tag }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="social_feed_details_section">
            <div class="social_feed_details_grid">
                <div class="social_feed_details_grid_client"><b>Client:</b> 
                    {% if task.taskclientrelations_set.first %}
                        {{ task.taskclientrelations_set.first.client.get_full_name|default:task.taskclientrelations_set.first.client.username }}
                    {% else %}
                        Not assigned
                    {% endif %}
                </div>
                <div class="social_feed_details_grid_date_start"><b>Date, time start:</b> 
                    {% if task.date_start %}
                        {{ task.date_start|date:'d.m.Y' }}
                        {% if task.time_start %}
                            {{ task.time_start|time:'H:i' }}
                        {% endif %}
                    {% else %}
                        Not set
                    {% endif %}
                </div>
                <div class="social_feed_details_grid_date_end"><b>Date, time end:</b> 
                    {% if task.date_end %}
                        {{ task.date_end|date:'d.m.Y' }}
                        {% if task.time_end %}
                            {{ task.time_end|time:'H:i' }}
                        {% endif %}
                    {% else %}
                        Not set
                    {% endif %}
                </div>
                {% if task.documents %}
                <div class="social_feed_details_grid_documents"><b>Documents:</b> <a href="{{ task.documents }}">Link</a></div>
                {% endif %}
                <div class="social_feed_details_grid_project_private"><b>Project private?:</b> {% if task.is_private %}Yes{% else %}No{% endif %}</div>
                <div class="social_feed_details_grid_customer_name"><b>Customer name:</b> 
                    {% if task.disclose_name %}
                        {% if task.taskownerrelations_set.first %}
                            {{ task.taskownerrelations_set.first.user.get_full_name|default:task.taskownerrelations_set.first.user.username }}
                        {% else %}
                            Not assigned
                        {% endif %}
                    {% else %}
                        Hidden
                    {% endif %}
                </div>
                <div class="social_feed_details_grid_stakeholders"><b>Stakeholders:</b> 
                    {% for performer in task.performers.all %}
                        {{ performer.get_full_name|default:performer.username }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                        Need a performer
                    {% endfor %}
                </div>
                <div class="social_feed_details_grid_status"><b>Status:</b> 
                    {% if task.status %}
                        {{ task.status.name }}
                    {% else %}
                        Not set
                    {% endif %}
                    {% if task.is_published %} - Published{% endif %}
                </div>
                <div class="social_feed_details_task_number"><b>Task number:</b> {{ task.id }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Попап для блокнота -->
<div id="my_task_notes_popup_{{ task.id }}" class="my_task_notes_popup_overlay my_task_notes_popup">
    <div class="my_task_notes_popup_content">
        <div class="my_task_notes_popup_header">
            <h3 class="my_task_notes_popup_title">Notes for task #{{ task.id }}</h3>
            <button class="my_task_notes_popup_close my_task_notes_close_btn" id="my_task_notes_close_{{ task.id }}">&times;</button>
        </div>
        <div class="my_task_notes_popup_body">
            <form id="my_task_notes_form_{{ task.id }}" method="POST" action="{% url 'services_and_projects:save_task_notes' task.id %}" class="my_task_notes_form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="my_task_notes_textarea_{{ task.id }}">Notes:</label>
                    <textarea id="my_task_notes_textarea_{{ task.id }}" name="notes" class="form-control my_task_notes_textarea">{{ task.note|default:'' }}</textarea>
                </div>
                <div class="my_task_notes_popup_actions">
                    <button type="submit" class="btn btn-primary my_task_notes_save_btn" id="my_task_notes_save_{{ task.id }}">Save</button>
                    <button type="button" class="btn btn-secondary my_task_notes_cancel_btn" id="my_task_notes_cancel_{{ task.id }}">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Подключаем скрипт для hover эффектов -->
<script src="{% static 'js/task_feed_hover.js' %}"></script>

<!-- Подключаем скрипт для dropdown menu -->
<script src="{% static 'js/my_task_feed.js' %}"></script>

