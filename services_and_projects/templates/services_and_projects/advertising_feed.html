{% load static %}

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º CSS –¥–ª—è Advertising Feed -->
<link rel="stylesheet" href="{% static 'css/advertising_feed.css' %}">

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º CSS –¥–ª—è Alertify -->
<link rel="stylesheet" href="{% static 'css/lib_alertify/alertify.css' %}">
<link rel="stylesheet" href="{% static 'css/lib_alertify/themes/default.css' %}">

<div class="social_feed" data-post-id="{{ advertising.id }}" data-post-type="advertising">
    <div class="social_feed_user_name">
        <div class="social_feed_user_name_image">
            {% if owner and owner.avatar %}
                <img src="{{ owner.avatar.url }}" alt="User Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
            {% else %}
                <div style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 32px;">
                    {{ owner.get_default_avatar_emoji|default:"üë§" }}
                </div>
            {% endif %}
            <div class="social_feed_user_text_name">
                {% if owner %}
                    {{ owner.get_full_name|default:owner.username }}
                {% else %}
                    Anonymous User
                {% endif %}
            </div>
        </div>
        <div class="advertising_social_feed_menu">
            <!-- Heart icon for favorites -->
            <span class="sftsts1_favorites_icon favorite-unchecked" id="favorites_icon_{{ advertising.id }}" data-favorite="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </span>
            <button class="advertising_social_feed_menu_trigger" id="menu_trigger_{{ advertising.id }}" type="button">
            </button>
            <div class="advertising_social_feed_overflow_menu" id="overflow_menu_{{ advertising.id }}">
                <div class="advertising_social_feed_overflow_menu_item edit" data-action="edit" data-id="{{ advertising.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                    Edit
                </div>
                
                {% if advertising.adv_mode == 'archived' %}
                    <!-- Show Unarchive and Remove for archived posts -->
                    <div class="advertising_social_feed_overflow_menu_item unarchive" data-action="unarchive" data-id="{{ advertising.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5l-4-4h2.5V12h3v1.5H16l-4 4z"/>
                        </svg>
                        Unarchive
                    </div>
                    <div class="advertising_social_feed_overflow_menu_item remove" data-action="remove" data-id="{{ advertising.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                        Remove
                    </div>
                {% else %}
                    <!-- Show Publish and Archive for non-archived posts -->
                    <div class="advertising_social_feed_overflow_menu_item publish" data-action="publish" data-id="{{ advertising.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                        Publish
                    </div>
                    <div class="advertising_social_feed_overflow_menu_item archive" data-action="archive" data-id="{{ advertising.id }}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5l-4-4h2.5V12h3v1.5H16l-4 4z"/>
                        </svg>
                        Archive
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="post_info">
        <span class="post_id">{{ advertising.id }}</span>
        <span class="post_date">{{ advertising.creation_date|date:'d.m.Y' }}</span>
    </div>
    <div class="social_feed_text">
        {% if advertising.description|length > 238 %}
            <p data-full-text="{{ advertising.description }}">{{ advertising.description|slice:":238" }}...</p>
            <div class="read_more">Read more...</div>
        {% else %}
            <p>{{ advertising.description }}</p>
        {% endif %}
    </div>
    <div class="social_feed_image_gallery_1">
        {% for photo in advertising.photos.all %}
            <a href="{{ photo.photo.url }}" 
               data-pswp-width="{{ photo.photo.width|default:1200 }}" 
               data-pswp-height="{{ photo.photo.height|default:800 }}"
               data-pswp-src="{{ photo.photo.url }}">
                <img src="{{ photo.photo.url }}" 
                     alt="Image {{ forloop.counter }}"
                     loading="lazy"
                     style="object-fit: cover; width: 100%; height: 100%;">
            </a>
        {% endfor %}
    </div>
    <div class="social_feed_tags">
        <span>
            {% for tag in advertising.hashtags.all %}
                {{ tag.tag }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </span>
    </div>
    <div class="post_actions">
        <div class="action_buttons">
            <button class="action_btn">Chat</button>
            <button class="action_btn">Comments</button>
        </div>
        <button class="order_now">Order now</button>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ testpage.html -->

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è Advertising Feed -->
<script src="{% static 'js/advertising_feed.js' %}"></script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è Alertify -->
<script src="{% static 'js/lib_alertify/alertify.js' %}"></script>

<script>
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ –¥–ª—è advertising_feed.html
    console.log('advertising_feed.html loaded');
    console.log('Post ID:', '{{ advertising.id }}');
    console.log('Post mode:', '{{ advertising.adv_mode }}');
    console.log('Menu trigger elements:', document.querySelectorAll('.advertising_social_feed_menu_trigger'));
    console.log('Dropdown elements:', document.querySelectorAll('.advertising_social_feed_overflow_menu'));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞
    const postId = '{{ advertising.id }}';
    const menuTrigger = document.getElementById(`menu_trigger_${postId}`);
    const dropdown = document.getElementById(`overflow_menu_${postId}`);
    
    console.log('Menu trigger for this post:', menuTrigger);
    console.log('Dropdown for this post:', dropdown);
    console.log('Menu trigger classes:', menuTrigger ? menuTrigger.className : 'N/A');
    console.log('Dropdown classes:', dropdown ? dropdown.className : 'N/A');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ AdvertisingFeed –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    setTimeout(() => {
        console.log('AdvertisingFeed object:', window.AdvertisingFeed);
        console.log('AdvertisingFeedUtils object:', window.AdvertisingFeedUtils);
        console.log('Active dropdown:', window.activeDropdown);
        
        // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
        if (window.AdvertisingFeedUtils) {
            console.log('Testing getOverflowMenuById:', window.AdvertisingFeedUtils.getOverflowMenuById(postId));
            console.log('Testing getMenuTriggerById:', window.AdvertisingFeedUtils.getMenuTriggerById(postId));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                addTestButtons();
            }
            
            // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            console.log('=== TESTING EDIT FUNCTIONS ===');
            console.log('window.testEditFunction:', typeof window.testEditFunction);
            console.log('window.openEditForm:', typeof window.openEditForm);
            if (typeof window.testEditFunction === 'function') {
                console.log('Test function result:', window.testEditFunction());
            }
        }
    }, 1000);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
    function addTestButtons() {
        const testContainer = document.createElement('div');
        testContainer.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; z-index: 10000; font-size: 12px;';
        testContainer.innerHTML = `
            <div style="margin-bottom: 10px;"><strong>Test Controls</strong></div>
            <button onclick="testThisDropdown()" style="display: block; width: 100%; margin-bottom: 5px; padding: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Test Dropdown</button>
            <button onclick="diagnoseThisPost()" style="display: block; width: 100%; padding: 5px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">Diagnose Post</button>
        `;
        document.body.appendChild(testContainer);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        window.testThisDropdown = function() {
            if (window.AdvertisingFeedUtils) {
                window.AdvertisingFeedUtils.testDropdown(postId);
            }
        };
        
        window.diagnoseThisPost = function() {
            if (window.AdvertisingFeedUtils) {
                console.log('=== DIAGNOSING THIS POST ===');
                console.log('Post ID:', postId);
                console.log('Menu trigger:', menuTrigger);
                console.log('Dropdown:', dropdown);
                console.log('Post element:', document.querySelector(`.social_feed[data-post-id="${postId}"]`));
            }
        };
    }
</script> 