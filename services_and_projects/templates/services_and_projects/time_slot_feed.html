{% load static %}

<!-- Подключаем CSS для Time Slot Feed -->
<link rel="stylesheet" href="{% static 'css/timeslot_feed.css' %}">

<!-- Подключаем CSS для Advertising Feed (для dropdown menu) -->
<link rel="stylesheet" href="{% static 'css/advertising_feed.css' %}">

<div class="social_feed_time_slot" data-timeslot-id="{{ time_slot.id }}" data-post-id="{{ time_slot.id }}" data-post-type="timeslot">
    <!-- Dropdown menu - аналогично advertising_feed.html -->
    <div class="advertising_social_feed_menu">
        <button class="advertising_social_feed_menu_trigger" id="menu_trigger_{{ time_slot.id }}" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
        </button>
        <div class="advertising_social_feed_overflow_menu" id="overflow_menu_{{ time_slot.id }}">
            <div class="advertising_social_feed_overflow_menu_item edit" data-action="edit" data-id="{{ time_slot.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                Edit
            </div>
            <div class="advertising_social_feed_overflow_menu_item publish" data-action="publish" data-id="{{ time_slot.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                Publish
            </div>
            <div class="advertising_social_feed_overflow_menu_item archive" data-action="archive" data-id="{{ time_slot.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5l-4-4h2.5V12h3v1.5H16l-4 4z"/>
                </svg>
                Archive
            </div>
        </div>
    </div>
    
    <div class="social_feed_time_slot_body_text">
        <div class="social_feed_time_slot_text_sections">
            <div class="social_feed_time_slot_text_section_1">
                <div class="sftsts1_company_name"> 
                    <span class="sftsts1_favorites_icon" id="favorites_icon_{{ time_slot.id }}" style="cursor: pointer; display: inline-block; vertical-align: middle;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="27.094" height="24.858" viewBox="0 0 33.867 31.073">
                            <path d="M96.934-822.927l-2.455-2.2q-4.276-3.852-7.07-6.646a46.843,46.843,0,0,1-4.445-5.016,15.937,15.937,0,0,1-2.307-4.085,11.387,11.387,0,0,1-.656-3.81,9.02,9.02,0,0,1,2.667-6.646A9.02,9.02,0,0,1,89.314-854a9.769,9.769,0,0,1,4.191.931,10.041,10.041,0,0,1,3.429,2.625,10.041,10.041,0,0,1,3.429-2.625,9.769,9.769,0,0,1,4.191-.931,9.02,9.02,0,0,1,6.646,2.667,9.02,9.02,0,0,1,2.667,6.646,11.387,11.387,0,0,1-.656,3.81,15.938,15.938,0,0,1-2.307,4.085,46.846,46.846,0,0,1-4.445,5.016q-2.794,2.794-7.07,6.646Zm0-4.572q4.064-3.641,6.689-6.244a52.757,52.757,0,0,0,4.149-4.53,14.157,14.157,0,0,0,2.117-3.429,8.088,8.088,0,0,0,.593-2.984,5.744,5.744,0,0,0-1.693-4.233,5.744,5.744,0,0,0-4.233-1.693,6.538,6.538,0,0,0-3.683,1.122,5.77,5.77,0,0,0-2.328,2.858H95.325A5.77,5.77,0,0,0,93-849.491a6.538,6.538,0,0,0-3.683-1.122,5.744,5.744,0,0,0-4.233,1.693,5.744,5.744,0,0,0-1.693,4.233,8.088,8.088,0,0,0,.593,2.984,14.157,14.157,0,0,0,2.117,3.429,52.757,52.757,0,0,0,4.149,4.53Q92.87-831.14,96.934-827.5ZM96.934-839.056Z" transform="translate(-80 854)" fill="#282d3b"/>
                        </svg>
                    </span>
                    {% if owner and owner.company_name %}
                        <span>{{ owner.company_name }}</span>
                    {% else %}
                        <span>No Company</span>
                    {% endif %}
                </div>
                <div class="sftsts1_use_name">
                    {% if owner %}
                        {{ owner.get_full_name|default:owner.username }}
                    {% else %}
                        Unknown User
                    {% endif %}
                </div>
                <div class="sftsts1_hour_price">1 hour: <span>{{ time_slot.cost_of_1_hour_of_work|floatformat:0 }}</span> £</div> 
                <div class="sftsts1_hour_price">min slot 
                    <span>
                        {% if time_slot.minimum_time_slot %}
                            {% if time_slot.minimum_time_slot == 60 %}
                                1 hour
                            {% elif time_slot.minimum_time_slot < 60 %}
                                {{ time_slot.minimum_time_slot }} minutes
                            {% else %}
                                {% widthratio time_slot.minimum_time_slot 60 1 %} hours
                            {% endif %}
                        {% else %}
                            Not specified
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="social_feed_time_slot_text_section_2">
                <div class="sftsts2_aviability">
                    Available at: 
                    <span class="sftsts2_aviability_start_date" id="sftsts2_aviability_start_date_id">
                        {{ time_slot.date_start|date:"m.d" }}
                    </span> - 
                    <span class="sftsts2_aviability_end_date" id="sftsts2_aviability_end_date">
                        {{ time_slot.date_end|date:"m.d" }}
                    </span>
                </div>
                <div class="sftsts2_time_slot">
                    Time-slot: 
                    <span class="sftsts2_time_slot_time">
                        <span class="sftsts2_time_slot_time_start_time" id="sftsts2_time_slot_time_start_time_id">
                            {{ time_slot.time_start|time:"H:i" }}
                        </span> - 
                        <span class="sftsts2_time_slot_time_end_time" id="sftsts2_time_slot_time_end_time_id">
                            {{ time_slot.time_end|time:"H:i" }}
                        </span>
                    </span>
                </div>
                <div class="sftsts2_reserved_road_time">
                    Reserved time on road: 
                    <span class="sftsts2_reserved_road_time_time" id="sftsts2_reserved_road_time_time_id">
                        {% if time_slot.reserved_time_on_road %}
                            {% if time_slot.reserved_time_on_road == 60 %}
                                1 hour
                            {% elif time_slot.reserved_time_on_road < 60 %}
                                {{ time_slot.reserved_time_on_road }} minutes
                            {% else %}
                                {% widthratio time_slot.reserved_time_on_road 60 1 %} hours
                            {% endif %}
                        {% else %}
                            No time reserved
                        {% endif %}
                    </span>
                </div>
                <div class="sftsts2_reserved_start_location">
                    start location: 
                    <span class="sftsts2_reserved_start_location_location" id="sftsts2_reserved_start_location_location_id">
                        {{ time_slot.start_location|default:"Not specified" }}
                    </span>
                </div>
            </div>

        </div>
        <div class="social_feed_time_slot_tag_section">
            <div class="social_feed_tags_scroll_container">
                <div class="social_feed_tags">
                    {% if time_slot.hashtags.all %}
                        {% for hashtag in time_slot.hashtags.all %}
                            <span>{{ hashtag.tag }}</span>
                        {% endfor %}
                    {% else %}
                        <span>No tags</span>
                    {% endif %}
                </div>
            </div>

        </div>
 
    </div>
    
    <!-- Right side with dropdown menu only -->
    <div class="time_slot_bottom_side">
        <div class="post_actions">
            <div class="action_buttons">
                <button class="action_btn">Chat</button>
                <button class="action_btn">Comments</button>
            </div>
            <button class="order_now">Book now</button>
        </div>

    </div>
</div>

<!-- Book now button and action buttons at the bottom after hashtags - same as advertising_feed.html -->


<!-- Подключаем скрипт для Time Slot Feed -->
<script src="{% static 'js/time_slot_feed.js' %}"></script>

<!-- Подключаем скрипт для Advertising Feed (для dropdown menu) -->
<script src="{% static 'js/advertising_feed.js' %}"></script>

<script>
    // Инициализация dropdown menu для time slot feed
    document.addEventListener('DOMContentLoaded', function() {
        // Ждем, пока AdvertisingFeed загрузится
        setTimeout(() => {
            if (window.AdvertisingFeed) {
                // Инициализируем dropdown menu для этого поста
                const postId = '{{ time_slot.id }}';
                console.log('Initializing dropdown for time slot:', postId);
                
                // Проверяем, что элементы существуют
                const menuTrigger = document.getElementById(`menu_trigger_${postId}`);
                const dropdown = document.getElementById(`overflow_menu_${postId}`);
                
                if (menuTrigger && dropdown) {
                    console.log('Dropdown elements found for time slot:', postId);
                    
                    // Добавляем обработчик для пунктов меню
                    const menuItems = dropdown.querySelectorAll('.advertising_social_feed_overflow_menu_item');
                    menuItems.forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            const action = this.dataset.action;
                            const id = this.dataset.id;
                            
                            console.log('Time slot action:', action, 'ID:', id);
                            
                            // Обрабатываем действия
                            switch(action) {
                                case 'edit':
                                    console.log('Editing time slot:', id);
                                    // Добавить логику редактирования
                                    break;
                                case 'publish':
                                    console.log('Publishing time slot:', id);
                                    // Добавить логику публикации
                                    break;
                                case 'archive':
                                    console.log('Archiving time slot:', id);
                                    // Добавить логику архивирования
                                    break;
                            }
                            
                            // Закрываем dropdown
                            dropdown.classList.remove('show');
                        });
                    });
                    
                    // Добавляем обработчик для кнопки меню
                    menuTrigger.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Закрываем все другие dropdown
                        document.querySelectorAll('.advertising_social_feed_overflow_menu.show').forEach(menu => {
                            if (menu !== dropdown) {
                                menu.classList.remove('show');
                            }
                        });
                        
                        // Переключаем текущий dropdown
                        dropdown.classList.toggle('show');
                    });
                    
                    // Добавляем обработчик для закрытия dropdown при клике вне его
                    document.addEventListener('click', function(e) {
                        if (!menuTrigger.contains(e.target) && !dropdown.contains(e.target)) {
                            dropdown.classList.remove('show');
                        }
                    });
                }
            }
        }, 1000); // Ждем 1 секунду для загрузки всех скриптов
    });
</script>