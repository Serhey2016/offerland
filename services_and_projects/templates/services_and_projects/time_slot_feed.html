{% load static %}

<!-- Подключаем CSS для Time Slot Feed -->
<link rel="stylesheet" href="{% static 'css/timeslot_feed.css' %}">

<!-- Подключаем CSS для My Task Feed (для dropdown menu) -->
<link rel="stylesheet" href="{% static 'css/my_task_feed.css' %}">

<!-- Дополнительные стили для time slot feed dropdown menu -->
<style>
    /* Стили для time slot feed dropdown menu */
    .social_feed_time_slot .my_task_social_feed_menu {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
    }
    
    /* Иконка трех точек для time slot feed */
    .social_feed_time_slot .my_task_social_feed_overflow_menu_trigger::after {
        content: "\22EE";
        right: 0;
        top: 0;
        color: #666;
        font-size: 1.4em;
        line-height: 1;
        display: block;
        transition: color 0.2s ease;
        pointer-events: none;
    }
    
    .social_feed_time_slot .my_task_social_feed_overflow_menu_trigger:hover::after {
        color: #333;
    }
    
    /* Позиционирование dropdown menu для time slot */
    .social_feed_time_slot .my_task_social_feed_overflow_menu {
        top: 100%;
        right: 0;
        margin-top: 4px;
    }
    
    /* Дополнительная защита - скрываем форму publish_form по умолчанию */
    .publish_form_popup {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
    
    /* Показываем только при наличии класса .show */
    .publish_form_popup.show {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
</style>

<div class="social_feed_time_slot" data-timeslot-id="{{ time_slot.id }}" data-post-id="{{ time_slot.id }}" data-post-type="timeslot" 
     data-category="{{ time_slot.category.id|default:'' }}" 
     data-services="{{ time_slot.services.id|default:'' }}"
     data-date-start="{{ time_slot.date_start|date:'Y-m-d' }}"
     data-time-start="{{ time_slot.time_start|time:'H:i' }}"
     data-date-end="{{ time_slot.date_end|date:'Y-m-d' }}"
     data-time-end="{{ time_slot.time_end|time:'H:i' }}"
     data-reserved-time="{{ time_slot.reserved_time_on_road|default:'' }}"
     data-start-location="{{ time_slot.start_location|default:'' }}"
     data-cost-hour="{{ time_slot.cost_of_1_hour_of_work|default:'' }}"
     data-min-slot="{{ time_slot.minimum_time_slot|default:'' }}"
     data-hashtags="{% for hashtag in time_slot.hashtags.all %}{{ hashtag.tag }}{% if not forloop.last %},{% endif %}{% endfor %}">
    
    <!-- Dropdown menu - используем структуру как в task_feed.html -->
    <div class="my_task_social_feed_menu" id="my_task_social_feed_menu_{{ time_slot.id }}">
        <!-- Heart icon for favorites -->
        <span class="sftsts1_favorites_icon favorite-unchecked" id="favorites_icon_{{ time_slot.id }}" data-favorite="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
        </span>
        
        <!-- Overflow Menu Icon Trigger -->
        <div class="my_task_social_feed_overflow_menu_trigger" id="overflow_menu_trigger_{{ time_slot.id }}">
        </div>
        <div class="my_task_social_feed_overflow_menu" id="my_task_overflow_menu_{{ time_slot.id }}">
            <div class="my_task_social_feed_overflow_menu_item edit" id="menu_item_edit_{{ time_slot.id }}" data-action="edit" data-id="{{ time_slot.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
                Edit
            </div>
            <div class="my_task_social_feed_overflow_menu_item publish" id="menu_item_publish_{{ time_slot.id }}" data-action="publish" data-id="{{ time_slot.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                Publish
            </div>
            <div class="my_task_social_feed_overflow_menu_item archive" id="menu_item_archive_{{ time_slot.id }}" data-action="archive" data-id="{{ time_slot.id }}">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5l-4-4h2.5V12h3v1.5H16l-4 4z"/>
                </svg>
                Archive
            </div>
        </div>
    </div>
    
    <div class="social_feed_time_slot_body_text">
        <div class="social_feed_time_slot_text_sections">
            <div class="social_feed_time_slot_text_section_1">
                <div class="sftsts1_company_name"> 

                    {% if owner and owner.company_name %}
                        <span>{{ owner.company_name }}</span>
                    {% else %}
                        <span>No Company</span>
                    {% endif %}
                </div>
                <div class="sftsts1_use_name">
                    {% if owner %}
                        {{ owner.get_full_name|default:owner.username }}
                    {% else %}
                        Unknown User
                    {% endif %}
                </div>
                <div class="sftsts1_hour_price">1 hour: <span>{{ time_slot.cost_of_1_hour_of_work|floatformat:0 }}</span> £</div> 
                <div class="sftsts1_hour_price">min slot 
                    <span>
                        {% if time_slot.minimum_time_slot %}
                            {% if time_slot.minimum_time_slot == 60 %}
                                1 hour
                            {% elif time_slot.minimum_time_slot < 60 %}
                                {{ time_slot.minimum_time_slot }} minutes
                            {% else %}
                                {% widthratio time_slot.minimum_time_slot 60 1 %} hours
                            {% endif %}
                        {% else %}
                            Not specified
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="social_feed_time_slot_text_section_2">
                <div class="sftsts2_aviability">
                    Available at: 
                    <span class="sftsts2_aviability_start_date" id="sftsts2_aviability_start_date_id">
                        {{ time_slot.date_start|date:"m.d" }}
                    </span> - 
                    <span class="sftsts2_aviability_end_date" id="sftsts2_aviability_end_date">
                        {{ time_slot.date_end|date:"m.d" }}
                    </span>
                </div>
                <div class="sftsts2_time_slot">
                    Time-slot: 
                    <span class="sftsts2_time_slot_time">
                        <span class="sftsts2_time_slot_time_start_time" id="sftsts2_time_slot_time_start_time_id">
                            {{ time_slot.time_start|time:"H:i" }}
                        </span> - 
                        <span class="sftsts2_time_slot_time_end_time" id="sftsts2_time_slot_time_end_time_id">
                            {{ time_slot.time_end|time:"H:i" }}
                        </span>
                    </span>
                </div>
                <div class="sftsts2_reserved_road_time">
                    Reserved time on road: 
                    <span class="sftsts2_reserved_road_time_time" id="sftsts2_reserved_road_time_time_id">
                        {% if time_slot.reserved_time_on_road %}
                            {% if time_slot.reserved_time_on_road == 60 %}
                                1 hour
                            {% elif time_slot.reserved_time_on_road < 60 %}
                                {{ time_slot.reserved_time_on_road }} minutes
                            {% else %}
                                {% widthratio time_slot.reserved_time_on_road 60 1 %} hours
                            {% endif %}
                        {% else %}
                            No time reserved
                        {% endif %}
                    </span>
                </div>
                <div class="sftsts2_reserved_start_location">
                    start location: 
                    <span class="sftsts2_reserved_start_location_location" id="sftsts2_reserved_start_location_location_id">
                        {{ time_slot.start_location|default:"Not specified" }}
                    </span>
                </div>
            </div>

        </div>
        <div class="social_feed_time_slot_tag_section">
            <div class="social_feed_tags_scroll_container">
                <div class="social_feed_tags">
                    {% if time_slot.hashtags.all %}
                        {% for hashtag in time_slot.hashtags.all %}
                            <span>{{ hashtag.tag }}</span>
                        {% endfor %}
                    {% else %}
                        <span>No tags</span>
                    {% endif %}
                </div>
            </div>

        </div>
 
    </div>
    
    <!-- Right side with dropdown menu only -->
    <div class="time_slot_bottom_side">
        <div class="post_actions">
            <div class="action_buttons">
                <button class="action_btn">Chat</button>
                <button class="action_btn">Comments</button>
            </div>
            <button class="order_now">Book now</button>
        </div>

    </div>
</div>

<!-- Подключаем CSS для Publish Form -->
<link rel="stylesheet" href="{% static 'css/publish_form.css' %}">

<!-- Подключаем скрипт для My Task Feed (для dropdown menu) -->
<script src="{% static 'js/my_task_feed.js' %}"></script>

<script>
    // Инициализация dropdown menu для time slot feed
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчик только для редактирования и архивирования
        // Publish обрабатывается глобально в publish_form.js
        document.addEventListener('click', function(e) {
            const menuItem = e.target.closest('[id^="menu_item_"][data-id="{{ time_slot.id }}"]');
            if (menuItem) {
                const action = menuItem.dataset.action;
                
                // Обрабатываем только edit и archive, publish обрабатывается глобально
                if (action === 'edit') {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const id = menuItem.dataset.id;
                    console.log('🔄 Edit action for time slot:', id);
                    
                    // Открываем форму редактирования
                    if (window.EditTimeSlotForm) {
                        // Получаем данные time slot для редактирования из data-атрибутов
                        const timeSlotElement = document.querySelector(`[data-timeslot-id="${id}"]`);
                        if (timeSlotElement) {
                            const hashtagsString = timeSlotElement.dataset.hashtags || '';
                            const hashtags = hashtagsString ? hashtagsString.split(',').filter(tag => tag.trim()) : [];
                            
                            const timeSlotData = {
                                category: timeSlotElement.dataset.category || '',
                                services: timeSlotElement.dataset.services || '',
                                date_start: timeSlotElement.dataset.dateStart || '',
                                time_start: timeSlotElement.dataset.timeStart || '',
                                date_end: timeSlotElement.dataset.dateEnd || '',
                                time_end: timeSlotElement.dataset.timeEnd || '',
                                reserved_time_on_road: timeSlotElement.dataset.reservedTime || '',
                                start_location: timeSlotElement.dataset.startLocation || '',
                                cost_of_1_hour_of_work: timeSlotElement.dataset.costHour || '',
                                minimum_time_slot: timeSlotElement.dataset.minSlot || '',
                                hashtags: hashtags
                            };
                            window.EditTimeSlotForm.openModal(id, timeSlotData);
                        }
                    } else {
                        console.error('EditTimeSlotForm not found');
                    }
                } else if (action === 'archive') {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const id = menuItem.dataset.id;
                    console.log('🗄️ Archive action for time slot:', id);
                    
                    // Добавить логику архивирования
                    // TODO: Implement archive functionality
                }
                // publish action обрабатывается глобально в publish_form.js
            }
        });
    });
</script>

<!-- Popup форма для публикации Time Slot -->
{% include 'services_and_projects/publish_form.html' with post_type='time_slot' post_id=time_slot.id %}